# This playbook can be used to create a new EC2 instance which will perform backups

# Create backup machine at aws with tag
- name: Create backup machine
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Ensure pip module requirements are installed
      apt: name={{item}}
      with_items:
        - python-pip
        - virtualenv
      become: yes

    - name: Ensure boto is installed
      pip: name=boto
      become: yes

    - name: Provision an instance
      ec2:
        region: us-east-1
        zone: us-east-1f
        vpc_subnet_id: subnet-31b23e3d
        key_name: MyEc2KeyPair
        group: SshSecurityGroup
        instance_type: t2.micro
        image: ami-43a15f3e
        wait: true
        exact_count: 1
        count_tag:
          Name: backup_creator_tag
        instance_tags:
          Name: backup_creator_tag
        assign_public_ip: yes
        instance_profile_name: s3-admin-access
      register: ec2

    - name: Add instance to inventory
      add_host:
        name: "{{item.public_ip}}"
        group: mine
      with_items: "{{ec2.instances}}"
    
    - name: Wait for SSH to come up
      wait_for:
        host: "{{item.public_ip}}"
        port: 22
        state: started
      with_items: "{{ec2.instances}}"